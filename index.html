<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Prohibitive Camping Areas in NH's White Mountains</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v10.6.0/ol.css">
  <style>
    html, body { margin: 0; padding: 0; height: 100%; display: flex; flex-direction: column; font-family: sans-serif; }
    #title {
      text-align: center;
      padding: 10px;
      font-family: sans-serif;
      /* Adjusted font sizes for H1 and H2 within the title div */
    }
    #title h1 {
      font-size: 1.8em; /* Main title */
      margin-bottom: 5px; /* Space between H1 and H2 */
    }
    #title h2 {
      font-size: 1.1em; /* Explanation text */
      color: #333;
      margin-top: 0;
      margin-bottom: 10px;
    }

    #map { flex: 1; position: relative; }
    #legend { padding: 10px; background: #f9f9f9; font-family: sans-serif; }
    #legend h3 { margin-top: 0; }
    #legend ul { margin: 0; padding-left: 20px; }


    /* Search Bar Styling */
    #search-container {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background-color: rgba(255, 255, 255, 0.9);
      padding: 8px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    #search-input-group {
        display: flex;
        gap: 5px;
    }
    #search-input {
      border: 1px solid #ccc;
      padding: 6px 10px;
      font-size: 1em;
      border-radius: 3px;
      width: 200px;
    }
    #search-button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 1em;
      flex-shrink: 0;
    }
    #search-button:hover {
      background-color: #0056b3;
    }
    #search-results {
        width: 100%;
        background-color: white;
        border: 1px solid #ccc;
        border-radius: 0 0 5px 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        max-height: 200px;
        overflow-y: auto;
        display: none;
        z-index: 999;
    }
    #search-results ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    #search-results li {
        padding: 8px 10px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
    }
    #search-results li:last-child {
        border-bottom: none;
    }
    #search-results li:hover {
        background-color: #f0f0f0;
    }

    /* Coordinate Tooltip Styling */
    #coordinate-tooltip {
      position: absolute;
      background: white;
      color: black;
      padding: 5px 8px;
      border-radius: 3px;
      white-space: nowrap;
      font-size: 0.85em;
      pointer-events: none;
      display: none;
      transform: translate(-50%, -100%);
      margin-top: -10px;
      border: 1px solid #ccc;
      font-family: sans-serif;
    }

    /* Footer Styling */
    footer {
        text-align: center;
        padding: 10px;
        font-size: 0.8em;
        color: #666;
        background: #f0f0f0;
        border-top: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <div id="title">
    <h1>Prohibitive Camping Areas in NH's White Mountains</h1>
    <h2><span style="color: red;">&#9632;</span> Red shaded areas indicate locations where dispersed/backcountry camping is strictly prohibited.</h2>
  </div>
  <div id="map">
    <div id="search-container">
      <div id="search-input-group">
        <input type="text" id="search-input" placeholder="Search for a mountain or trail...">
        <button id="search-button">Go</button>
      </div>
      <div id="search-results">
          <ul></ul>
      </div>
    </div>
    <div id="coordinate-tooltip"></div>
  </div>
  <div id="legend">
    <h3>Camping Regulations</h3>
    <ul>
      <li>Camp at least <strong>200 ft</strong> from trails and water bodies.</li>
      <li>Camp at least <strong>1/4 mile</strong> from backcountry facilities (shelters, huts, trailheads).</li>
      <li>No camping in the alpine zone (trees &le;8 ft) except when &ge;2 ft of snow cover.</li>
      <li>Camp at least <strong>1/4 mile</strong> from designated roads.</li>
    </ul>
  </div>

  <footer>
    <p>Map and content by Aaron Perry.</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/ol@v10.6.0/dist/ol.js"></script>
  <script>
    window.onload = function() {
      // Validate OpenLayers global
      if (typeof ol === "undefined") {
        console.error("OpenLayers library not found. Make sure the script src is correct and served over HTTP/HTTPS.");
        return;
      }

      // Common style for GeoJSON layers
      const geojsonStyle = new ol.style.Style({
        fill: new ol.style.Fill({ color: 'rgba(255, 0, 0, 0.5)' }),
        stroke: new ol.style.Stroke({ color: 'red', width: 2 })
      });

      // Factory for vector layers
      function createGeojsonLayer(url) {
        return new ol.layer.Vector({
          source: new ol.source.Vector({ url: url, format: new ol.format.GeoJSON() }),
          style: geojsonStyle
        });
      }

      // Define the Gaia GPS USFS Classic basemap
      const gaiaUsfsBasemap = new ol.layer.Tile({
        source: new ol.source.XYZ({
          attributions: 'Tiles &copy; <a href="https://www.gaiagps.com/">Gaia GPS</a> / USFS Classic',
          url: 'https://statictiles.gaiagps.com/usfs-classic/{z}/{x}/{y}.png',
          minZoom: 0,
          maxZoom: 18
        })
      });

      // Define layers, starting with the Gaia GPS basemap
      const layers = [
        gaiaUsfsBasemap,
        createGeojsonLayer('simplified_SE.geojson'),
        createGeojsonLayer('simplified_SW.geojson'),
        createGeojsonLayer('simplified_NE.geojson'),
        createGeojsonLayer('simplified_NW.geojson')
      ];

      // Initialize map
      const map = new ol.Map({
        target: 'map',
        layers: layers,
        view: new ol.View({
          center: ol.proj.fromLonLat([-71.30, 44.27]), // Mount Washington
          zoom: 11
        })
      });

      // --- Search Bar Logic ---
      const searchInput = document.getElementById('search-input');
      const searchButton = document.getElementById('search-button');
      const searchResultsDiv = document.getElementById('search-results');
      const searchResultsList = searchResultsDiv.querySelector('ul');
      const searchContainer = document.getElementById('search-container');

      // Debounce function to limit API calls
      function debounce(func, delay) {
        let timeout;
        return function(...args) {
          const context = this;
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(context, args), delay);
        };
      }

      // Function to perform geocoding
      async function geocodeAddress(query) {
        if (query.length < 3) {
            searchResultsDiv.style.display = 'none';
            return [];
        }
        const viewbox = "-71.7,43.8,-71.0,44.6";
        const nominatimUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&addressdetails=1&viewbox=${viewbox}&bounded=1`;

        try {
          const response = await fetch(nominatimUrl, {
              headers: {
                  'User-Agent': 'ProhibitiveCampingMap/1.0 (your-email@example.com)' // REPLACE WITH YOUR EMAIL!
              }
          });
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          return data;
        } catch (error) {
          console.error("Error during geocoding:", error);
          return [];
        }
      }

      // Function to zoom to a location
      function zoomToLocation(lon, lat, zoomLevel = 14) {
        const view = map.getView();
        const coords = ol.proj.fromLonLat([parseFloat(lon), parseFloat(lat)]);
        view.animate({
          center: coords,
          zoom: zoomLevel,
          duration: 1000
        });
      }

      // Display search results
      function displaySearchResults(results) {
        searchResultsList.innerHTML = '';
        if (results && results.length > 0) {
          results.forEach(result => {
            const li = document.createElement('li');
            const displayName = result.display_name;
            li.textContent = displayName;
            li.dataset.lon = result.lon;
            li.dataset.lat = result.lat;
            li.addEventListener('click', () => {
              zoomToLocation(result.lon, result.lat);
              searchResultsDiv.style.display = 'none';
              searchInput.value = displayName;
            });
            searchResultsList.appendChild(li);
          });
          searchResultsDiv.style.display = 'block';
        } else {
          const li = document.createElement('li');
          li.textContent = "No results found.";
          searchResultsList.appendChild(li);
          searchResultsDiv.style.display = 'block';
        }
      }

      // --- Event Listeners for Search ---
      searchInput.addEventListener('input', debounce(async () => {
        const query = searchInput.value.trim();
        if (query.length > 2) {
          const results = await geocodeAddress(query);
          displaySearchResults(results);
        } else {
          searchResultsDiv.style.display = 'none';
        }
      }, 300));

      searchButton.addEventListener('click', async () => {
        const query = searchInput.value.trim();
        if (query) {
          const results = await geocodeAddress(query);
          displaySearchResults(results);
          if (results.length === 1) {
              zoomToLocation(results[0].lon, results[0].lat);
              searchResultsDiv.style.display = 'none';
          }
        }
      });

      searchInput.addEventListener('keypress', async (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          if (searchResultsList.children.length > 0 && searchResultsDiv.style.display === 'block') {
            searchResultsList.children[0].click();
          } else {
            const query = searchInput.value.trim();
            if (query) {
                const results = await geocodeAddress(query);
                displaySearchResults(results);
                if (results.length > 0) {
                    zoomToLocation(results[0].lon, results[0].lat);
                    searchResultsDiv.style.display = 'none';
                }
            }
          }
        }
      });

      document.addEventListener('click', (event) => {
        if (!searchContainer.contains(event.target) && !searchResultsDiv.contains(event.target)) {
          searchResultsDiv.style.display = 'none';
        }
      });
      searchInput.addEventListener('focus', () => {
          if (searchResultsList.children.length > 0 && searchResultsList.children[0].textContent !== "No results found.") {
              searchResultsDiv.style.display = 'block';
          }
      });


      // --- Coordinate Tooltip Logic ---
      const coordinateTooltipElement = document.getElementById('coordinate-tooltip');

      const coordinateOverlay = new ol.Overlay({
          element: coordinateTooltipElement,
          offset: [0, -15],
          positioning: 'bottom-center'
      });
      map.addOverlay(coordinateOverlay);

      map.on('pointermove', function(event) {
          const coordinate = event.coordinate;
          const lonLat = ol.proj.toLonLat(coordinate);

          const lat = lonLat[1].toFixed(4);
          const lon = lonLat[0].toFixed(4);
          coordinateTooltipElement.innerHTML = `${lat}, ${lon}`;

          coordinateOverlay.setPosition(coordinate);
          coordinateTooltipElement.style.display = 'block';
      });

      map.getViewport().addEventListener('mouseout', function() {
          coordinateTooltipElement.style.display = 'none';
      });
    };
  </script>
</body>
</html>
